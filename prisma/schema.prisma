generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Audit {
  id               String        @id
  projectId        String
  status           String
  startedAt        DateTime      @default(now())
  completedAt      DateTime?
  pagesCrawled     Int           @default(0)
  pagesTotal       Int           @default(0)
  overallScore     Float?
  technicalScore   Float?
  contentScore     Float?
  performanceScore Float?
  pausedAt         DateTime?
  Project          Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  AuditLog         AuditLog[]
  CrawlResult      CrawlResult[]
  Issue            Issue[]

  @@index([projectId])
  @@index([startedAt])
}

model AuditComparison {
  id              String   @id
  projectId       String
  previousAuditId String
  currentAuditId  String
  newIssues       Int      @default(0)
  fixedIssues     Int      @default(0)
  improvedScore   Float?
  createdAt       DateTime @default(now())

  @@unique([previousAuditId, currentAuditId])
  @@index([projectId])
}

model AuditLog {
  id        String   @id
  auditId   String
  category  String
  message   String
  metadata  Json?
  createdAt DateTime @default(now())
  Audit     Audit    @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@index([category])
  @@index([createdAt])
}

model Backlink {
  id           String      @id
  projectId    String
  sourcePageId String
  linkId       String?
  anchorText   String?
  isDofollow   Boolean     @default(true)
  isSponsored  Boolean     @default(false)
  isUgc        Boolean     @default(false)
  discoveredAt DateTime    @default(now())
  lastSeenAt   DateTime    @default(now())
  isActive     Boolean     @default(true)
  linkPosition String?
  Link         Link?       @relation(fields: [linkId], references: [id])
  Project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  CrawlResult  CrawlResult @relation(fields: [sourcePageId], references: [id], onDelete: Cascade)

  @@unique([projectId, sourcePageId, linkId])
  @@index([discoveredAt])
  @@index([isActive])
  @@index([isDofollow])
  @@index([projectId])
  @@index([sourcePageId])
}

model CrawlResult {
  id                  String     @id
  auditId             String?
  domainId            String?
  url                 String
  statusCode          Int
  title               String?
  metaDescription     String?
  metaKeywords        String?
  canonicalUrl        String?
  language            String?
  responseTimeMs      Int
  contentLength       Int?
  crawledAt           DateTime   @default(now())
  lastModified        DateTime?
  etag                String?
  redirectChain       Json?
  redirectCount       Int        @default(0)
  finalUrl            String?
  structuredData      Json?
  completenessScore   Float?
  accuracyScore       Float?
  freshnessScore      Float?
  h1Count             Int        @default(0)
  h2Count             Int        @default(0)
  h3Count             Int        @default(0)
  internalLinksCount  Int        @default(0)
  externalLinksCount  Int        @default(0)
  imagesCount         Int        @default(0)
  imagesWithAltCount  Int        @default(0)
  metaRobots          String?
  wordCount           Int?
  contentQualityScore Float?
  contentDepthScore   Float?
  httpHeaders         Json?
  contentHash         String?
  performanceMetrics  Json?
  mobileMetrics       Json?
  Backlink            Backlink[]
  Audit               Audit?     @relation(fields: [auditId], references: [id], onDelete: Cascade)
  Domain              Domain?    @relation(fields: [domainId], references: [id])
  Heading             Heading[]
  Image               Image[]
  Issue               Issue[]
  Link                Link[]
  OgTag               OgTag?

  @@index([auditId])
  @@index([crawledAt])
  @@index([domainId])
  @@index([finalUrl])
  @@index([statusCode])
  @@index([url])
  @@index([auditId, url])
  @@index([contentHash])
  @@index([url, crawledAt])
}

model CrawlSchedule {
  id             String    @id
  projectId      String?
  domainId       String?
  url            String?
  crawlFrequency String
  priority       Int       @default(5)
  lastCrawledAt  DateTime?
  nextCrawlAt    DateTime
  isActive       Boolean   @default(true)
  crawlType      String
  Domain         Domain?   @relation(fields: [domainId], references: [id], onDelete: Cascade)
  Project        Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([crawlType])
  @@index([domainId])
  @@index([isActive])
  @@index([nextCrawlAt])
  @@index([projectId])
}

model Domain {
  id            String          @id
  domain        String          @unique
  baseUrl       String
  robotsTxtUrl  String?
  sitemapUrl    String?
  crawlDelay    Int?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  CrawlResult   CrawlResult[]
  CrawlSchedule CrawlSchedule[]
}

model Heading {
  id            String      @id
  crawlResultId String
  level         Int
  text          String
  order         Int
  CrawlResult   CrawlResult @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)

  @@index([crawlResultId])
  @@index([level])
}

model Image {
  id            String      @id
  crawlResultId String
  src           String
  alt           String?
  title         String?
  width         Int?
  height        Int?
  order         Int
  CrawlResult   CrawlResult @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)

  @@index([crawlResultId])
}

model Issue {
  id             String       @id
  auditId        String?
  crawlResultId  String?
  severity       String
  category       String
  type           String
  message        String
  recommendation String?
  details        Json?
  Audit          Audit?       @relation(fields: [auditId], references: [id], onDelete: Cascade)
  CrawlResult    CrawlResult? @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@index([category])
  @@index([crawlResultId])
  @@index([severity])
}

model Link {
  id            String      @id
  crawlResultId String
  href          String
  text          String?
  isExternal    Boolean
  rel           String?
  order         Int
  Backlink      Backlink[]
  CrawlResult   CrawlResult @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)

  @@index([crawlResultId])
  @@index([href])
  @@index([isExternal])
}

model OgTag {
  id            String      @id
  crawlResultId String      @unique
  title         String?
  description   String?
  image         String?
  type          String?
  url           String?
  CrawlResult   CrawlResult @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)
}

model Project {
  id            String          @id
  name          String
  baseUrl       String
  domain        String          @unique
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  Audit         Audit[]
  Backlink      Backlink[]
  CrawlSchedule CrawlSchedule[]
}

model User {
  id        String   @id
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime
}
