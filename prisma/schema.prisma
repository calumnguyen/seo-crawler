// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Connection URL is configured in prisma.config.ts
  // Neon supports connection pooling - use ?pgbouncer=true for pooled connections
}

// ============================================
// USERS
// ============================================

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// PROJECTS & DOMAINS
// ============================================

model Project {
  id        String   @id @default(uuid())
  name      String
  baseUrl   String // e.g., "https://example.com"
  domain    String   @unique // e.g., "example.com"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  audits         Audit[]
  backlinks      Backlink[] // Backlinks pointing TO this project
  crawlSchedules CrawlSchedule[]
}

model Domain {
  id           String   @id @default(uuid())
  domain       String   @unique // e.g., "example.com"
  baseUrl      String // e.g., "https://example.com"
  robotsTxtUrl String?
  sitemapUrl   String?
  crawlDelay   Int? // From robots.txt (seconds)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  crawlResults   CrawlResult[] // External crawl results from this domain
  crawlSchedules CrawlSchedule[]
}

// ============================================
// INTERNAL AUDITS (Target Website Crawling)
// ============================================

model Audit {
  id           String    @id @default(uuid())
  projectId    String
  status       String // pending, pending_approval, in_progress, paused, stopped, completed, failed
  startedAt    DateTime  @default(now())
  pausedAt     DateTime? // When crawl was paused
  completedAt  DateTime?
  pagesCrawled Int       @default(0)
  pagesTotal   Int       @default(0)

  // Audit summary scores
  overallScore     Float? // 0-100 overall SEO score
  technicalScore   Float?
  contentScore     Float?
  performanceScore Float?

  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  crawlResults CrawlResult[]
  issues       Issue[]
  auditLogs    AuditLog[]

  @@index([projectId])
  @@index([startedAt])
}

model AuditLog {
  id        String   @id @default(uuid())
  auditId   String
  category  String // setup, filtering, queued, crawled, skipped
  message   String
  metadata  Json? // Additional context (URLs, counts, etc.)
  createdAt DateTime @default(now())

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@index([category])
  @@index([createdAt])
}

model CrawlResult {
  id              String  @id @default(uuid())
  auditId         String? // null = external crawl (for backlink discovery)
  domainId        String? // For external crawls
  url             String
  statusCode      Int
  title           String?
  metaDescription String?
  metaKeywords    String?
  canonicalUrl    String?
  language        String? // ISO 639-1 code (en, es, etc.)

  // Performance metrics
  responseTimeMs Int
  contentLength  Int?

  // Crawl metadata
  crawledAt    DateTime  @default(now())
  lastModified DateTime? // From HTTP headers
  etag         String? // For change detection

  // Redirect tracking
  redirectChain Json? // Array of redirect URLs
  redirectCount Int     @default(0)
  finalUrl      String? // Final destination after redirects

  // Structured data
  structuredData Json? // JSON-LD, Schema.org data

  // Quality scores (0.0-1.0)
  completenessScore Float?
  accuracyScore     Float?
  freshnessScore    Float?

  // Counts (denormalized for quick queries)
  h1Count            Int @default(0)
  h2Count            Int @default(0)
  h3Count            Int @default(0)
  internalLinksCount Int @default(0)
  externalLinksCount Int @default(0)
  imagesCount        Int @default(0)
  imagesWithAltCount Int @default(0)

  // Relations
  audit     Audit?     @relation(fields: [auditId], references: [id], onDelete: Cascade)
  domain    Domain?    @relation(fields: [domainId], references: [id])
  headings  Heading[]
  images    Image[]
  links     Link[]
  issues    Issue[]
  backlinks Backlink[] // Links FROM this page TO target projects
  ogTags    OgTag?

  @@index([auditId])
  @@index([domainId])
  @@index([url])
  @@index([crawledAt])
  @@index([statusCode])
  @@index([finalUrl]) // For redirect tracking
}

// ============================================
// SEO ISSUES (For Audit Reports)
// ============================================

model Issue {
  id             String  @id @default(uuid())
  auditId        String?
  crawlResultId  String?
  severity       String // error, warning, info
  category       String // technical, content, performance, mobile, etc.
  type           String // missing_title, duplicate_content, slow_load, etc.
  message        String
  recommendation String? // How to fix it

  // Issue details (flexible JSON)
  details Json? // Additional context

  audit       Audit?       @relation(fields: [auditId], references: [id], onDelete: Cascade)
  crawlResult CrawlResult? @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@index([severity])
  @@index([category])
  @@index([crawlResultId])
}

// ============================================
// DETAILED DATA (Headings, Images, Links)
// ============================================

model Heading {
  id            String @id @default(uuid())
  crawlResultId String
  level         Int // 1, 2, or 3
  text          String
  order         Int // Order on page

  crawlResult CrawlResult @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)

  @@index([crawlResultId])
  @@index([level])
}

model Image {
  id            String  @id @default(uuid())
  crawlResultId String
  src           String // Full image URL
  alt           String?
  title         String?
  width         Int?
  height        Int?
  order         Int // Order on page

  crawlResult CrawlResult @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)

  @@index([crawlResultId])
}

model Link {
  id            String  @id @default(uuid())
  crawlResultId String
  href          String // Full URL
  text          String? // Link text/anchor
  isExternal    Boolean
  rel           String? // nofollow, sponsored, etc.
  order         Int // Order on page

  crawlResult CrawlResult @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)
  backlinks   Backlink[] // Backlinks that reference this link

  @@index([crawlResultId])
  @@index([isExternal])
  @@index([href]) // For backlink discovery queries
}

model OgTag {
  id            String  @id @default(uuid())
  crawlResultId String  @unique
  title         String?
  description   String?
  image         String?
  type          String?
  url           String?

  crawlResult CrawlResult @relation(fields: [crawlResultId], references: [id], onDelete: Cascade)
}

// ============================================
// BACKLINK DISCOVERY
// ============================================

model Backlink {
  id           String  @id @default(uuid())
  projectId    String // Target project (the site being linked TO)
  sourcePageId String // CrawlResult ID (the page linking FROM)
  linkId       String? // Link ID (the specific link element)

  // Backlink attributes
  anchorText  String? // Link text
  isDofollow  Boolean @default(true) // false if rel="nofollow"
  isSponsored Boolean @default(false)
  isUgc       Boolean @default(false) // User-generated content

  // Discovery metadata
  discoveredAt DateTime @default(now())
  lastSeenAt   DateTime @default(now()) // Last time we saw this link
  isActive     Boolean  @default(true) // Link still exists?

  // Link position (optional, for analysis)
  linkPosition String? // header, footer, body, sidebar

  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourcePage CrawlResult @relation(fields: [sourcePageId], references: [id], onDelete: Cascade)
  link       Link?       @relation(fields: [linkId], references: [id], onDelete: SetNull)

  @@unique([projectId, sourcePageId, linkId]) // Prevent duplicates
  @@index([projectId])
  @@index([sourcePageId])
  @@index([discoveredAt])
  @@index([isActive])
  @@index([isDofollow])
}

// ============================================
// CRAWL SCHEDULING (Auto-Crawl)
// ============================================

model CrawlSchedule {
  id             String    @id @default(uuid())
  projectId      String? // For internal audits
  domainId       String? // For external crawls
  url            String? // Specific URL or null for entire domain
  crawlFrequency String // hourly, daily, weekly, monthly
  priority       Int       @default(5) // 0-10
  lastCrawledAt  DateTime?
  nextCrawlAt    DateTime
  isActive       Boolean   @default(true)

  // Crawl type
  crawlType String // internal_audit, external_backlink, sitemap_discovery

  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  domain  Domain?  @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([domainId])
  @@index([nextCrawlAt])
  @@index([isActive])
  @@index([crawlType])
}

// ============================================
// AUDIT COMPARISONS (Track Changes Over Time)
// ============================================

model AuditComparison {
  id              String @id @default(uuid())
  projectId       String
  previousAuditId String
  currentAuditId  String

  // Changes detected
  newIssues     Int    @default(0)
  fixedIssues   Int    @default(0)
  improvedScore Float? // Score improvement

  createdAt DateTime @default(now())

  @@unique([previousAuditId, currentAuditId])
  @@index([projectId])
}
